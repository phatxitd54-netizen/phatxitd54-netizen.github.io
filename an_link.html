<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Shaka M3U ClearKey Player</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">

  <style>
    body { margin: 0; background: #000; color: #fff; font-family: Arial; }
    #video { width: 100%; height: 60vh; background: #000; }
    #channelList { width: 100%; padding: 10px; font-size: 16px; }
    iframe { width: 100%; height: 40vh; border: none; }
  </style>
</head>
<body>

  <select id="channelList"></select>
  <video id="video" controls autoplay></video>

  <!-- Player PHP của bạn -->
  <iframe src="https://phatxitd54-netizen.github.io/player.php"></iframe>

<script>
async function loadM3U() {
  const res = await fetch("channels.php");
  const text = await res.text();

  const lines = text.split("\n");
  const channels = [];

  let current = null;
  let pendingKid = null;
  let pendingKey = null;

  for (let line of lines) {
    line = line.trim();

    if (line.startsWith("#EXTINF")) {
      const nameMatch = line.match(/,(.*)$/);
      current = {
        name: nameMatch ? nameMatch[1] : "Kênh",
        url: "",
        kid: null,
        key: null
      };
      pendingKid = null;
      pendingKey = null;
    }

    else if (line.startsWith("#KODIPROP:inputstream.adaptive.license_key")) {
      const kv = line.split("=").pop();
      if (kv.includes(":")) {
        const [kid, key] = kv.split(":");
        pendingKid = kid.trim();
        pendingKey = key.trim();
      }
    }

    else if (line && !line.startsWith("#")) {
      if (current) {
        current.url = line;
        if (pendingKid && pendingKey) {
          current.kid = pendingKid;
          current.key = pendingKey;
        }
        channels.push(current);
        current = null;
      }
    }
  }

  const select = document.getElementById("channelList");
  select.innerHTML = "";

  channels.forEach((ch, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = ch.name;
    select.appendChild(opt);
  });

  select.onchange = () => playChannel(channels[select.value]);

  if (channels.length) playChannel(channels[0]);
}

async function playChannel(ch) {
  const video = document.getElementById("video");

  if (window.player) await window.player.destroy();

  const player = new shaka.Player(video);
  window.player = player;

  if (ch.kid && ch.key) {
    player.configure({
      drm: {
        clearKeys: {
          [ch.kid]: ch.key
        }
      }
    });
  }

  try {
    await player.load(ch.url);
  } catch (e) {
    alert("Không load được kênh này");
    console.error(e);
  }
}

loadM3U();
</script>

</body>
</html>