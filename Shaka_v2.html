<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Shaka Player | ClearKey</title>

  <!-- Shaka UI CSS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css"/>

  <style>
    body {
      margin: 0;
      background: #000;
    }
    .shaka-video-container {
      width: 100%;
      height: 100vh;
    }
    video {
      width: 100%;
      height: 100%;
      background: #000;
    }
  </style>
</head>
<body>

<div class="shaka-video-container" data-shaka-player-container>
  <video autoplay playsinline data-shaka-player></video>
</div>

<!-- ✅ SHAKA PLAYER COMPILED -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js"></script>

<script>
function getParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    mpd: p.get("mpd"),
    key: p.get("key")
  };
}

async function init() {
  const { mpd, key } = getParams();

  if (!mpd) {
    alert("Thiếu tham số mpd");
    return;
  }

  if (!shaka.Player.isBrowserSupported()) {
    alert("Trình duyệt không hỗ trợ Shaka");
    return;
  }

  const video = document.querySelector("video");
  const player = new shaka.Player(video);

  // UI config
  const ui = video.ui;
  ui.configure({
    controlPanelElements: [
      "play_pause",
      "time_and_duration",
      "mute",
      "volume",
      "spacer",
      "quality",
      "fullscreen"
    ]
  });

  // Error log
  player.addEventListener("error", e => {
    console.error("Shaka error:", e.detail);
  });

  // ===== CLEARKEY =====
  if (key) {
    const [kid, clearkey] = key.split(":");
    if (kid && clearkey) {
      player.configure({
        drm: {
          clearKeys: {
            [kid]: clearkey
          }
        }
      });
    }
  }

  try {
    await player.load(mpd);
    console.log("Đang phát:", mpd);
  } catch (e) {
    console.error("Load lỗi:", e);
    alert("Không phát được stream");
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
