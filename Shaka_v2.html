<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Shaka Player v2 (Fixed)</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css"/>

  <style>
    body { margin: 0; background: #000; }
    .shaka-video-container { width: 100%; height: 100vh; }
    video { width: 100%; height: 100%; background: #000; }
  </style>
</head>
<body>

<div class="shaka-video-container" data-shaka-player-container>
  <!-- ❌ KHÔNG autoplay -->
  <video playsinline data-shaka-player></video>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js"></script>

<script>
function getParams() {
  const p = new URLSearchParams(location.search);
  return {
    videoUrl: p.get("videoUrl"),
    keys: p.get("keys")
  };
}

document.addEventListener("DOMContentLoaded", () => {
  const { videoUrl, keys } = getParams();
  if (!videoUrl) return alert("Thiếu videoUrl");

  const video = document.querySelector("video");
  const player = new shaka.Player(video);

  /* ===== UI ===== */
  const ui = video.ui;
  ui.configure({
    controlPanelElements: [
      "play_pause",
      "time_and_duration",
      "mute",
      "volume",
      "spacer",
      "quality",
      "fullscreen"
    ]
  });

  /* ===== DRM ===== */
  if (keys) {
    const clearKeys = {};
    keys.split(",").forEach(k => {
      const [kid, key] = k.split(":");
      if (kid && key) clearKeys[kid] = key;
    });
    player.configure({ drm: { clearKeys } });
  }

  player.addEventListener("error", e => {
    console.error("Shaka error:", e.detail);
  });

  /* ===== FIX CHÍNH Ở ĐÂY =====
     Chỉ load khi user bấm PLAY */
  let loaded = false;
  video.addEventListener("play", async () => {
    if (loaded) return;
    loaded = true;
    try {
      await player.load(videoUrl);
      console.log("Loaded after user gesture");
    } catch (e) {
      console.error("Load error:", e);
      alert("Không phát được stream");
    }
  }, { once: true });
});
</script>

</body>
</html>
