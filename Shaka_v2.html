<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Shaka Player v2</title>

  <!-- Shaka UI CSS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css"/>

  <style>
    body {
      margin: 0;
      background: #000;
    }
    .shaka-video-container {
      width: 100%;
      height: 100vh;
    }
    video {
      width: 100%;
      height: 100%;
      background: #000;
    }
  </style>
</head>
<body>

<div class="shaka-video-container" data-shaka-player-container>
  <video autoplay playsinline data-shaka-player></video>
</div>

<!-- Shaka Player -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js"></script>

<script>
function getParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    videoUrl: p.get("videoUrl"),
    keys: p.get("keys")
  };
}

async function init() {
  const { videoUrl, keys } = getParams();

  if (!videoUrl) {
    alert("Thiếu tham số videoUrl");
    return;
  }

  if (!shaka.Player.isBrowserSupported()) {
    alert("Trình duyệt không hỗ trợ Shaka Player");
    return;
  }

  const video = document.querySelector("video");
  const player = new shaka.Player(video);

  /* UI */
  const ui = video.ui;
  ui.configure({
    controlPanelElements: [
      "play_pause",
      "time_and_duration",
      "mute",
      "volume",
      "spacer",
      "quality",
      "fullscreen"
    ]
  });

  /* Log lỗi */
  player.addEventListener("error", e => {
    console.error("Shaka error:", e.detail);
  });

  /* ===== CLEARKEY ===== */
  if (keys) {
    // hỗ trợ nhiều key: kid1:key1,kid2:key2
    const clearKeys = {};
    keys.split(",").forEach(pair => {
      const [kid, key] = pair.split(":");
      if (kid && key) {
        clearKeys[kid] = key;
      }
    });

    player.configure({
      drm: { clearKeys }
    });
  }

  try {
    await player.load(videoUrl);
    console.log("Đang phát:", videoUrl);
  } catch (e) {
    console.error("Load lỗi:", e);
    alert("Không phát được stream");
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
