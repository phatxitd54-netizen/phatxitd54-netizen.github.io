<!DOCTYPE html>
<html lang="vi">
<head>
    <head>
  <meta charset="utf-8">
  <title>Shaka Player - Danh s√°ch k√™nh (KODIPROP)</title>

  <!-- Shaka CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">

  <!-- Plyr CSS (d√°n th√™m d√≤ng n√†y) -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">

  <style>
    /* CSS hi·ªán t·∫°i c·ªßa b·∫°n ·ªü ƒë√¢y */
  </style>
</head>
<meta charset="UTF-8">
<title>Shaka Player - KODIPROP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#111;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  padding:10px;
  background:#1e1e1e;
  text-align:center;
  font-weight:bold;
}

#container{
  display:flex;
  flex:1;
  overflow:hidden;
}

#channel-list{
  width:220px;
  background:#1a1a1a;
  overflow-y:auto;
}

.channel-item{
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
}

.channel-item:hover{background:#2a2a2a}
.channel-item.active{background:#0066cc}

#player-area{
  flex:1;
  background:#000;
  display:flex;
  flex-direction:column;
}

video{
  flex:1;
  width:100%;
  height:100%;
  object-fit:contain; /* ƒë·ªïi th√†nh cover n·∫øu mu·ªën full k√≠n */
}

#now-playing{
  padding:8px;
  background:#1e1e1e;
  border-top:1px solid #333;
  font-size:14px;
}
@media (max-width: 768px){
  #channel-list{display:none;}
}
#toggleListBtn{
  float:right;
  background:#0066cc;
  color:#fff;
  border:none;
  border-radius:4px;
  padding:6px 10px;
  font-size:16px;
  cursor:pointer;
}

#toggleListBtn:hover{
  background:#0080ff;
}
</style>
</head>

<body>
<<header>
  Shaka Player - Danh s√°ch k√™nh (KODIPROP)
  <button id="toggleListBtn">‚ò∞</button>
</header>

<div id="container">
  <div id="channel-list">ƒêang t·∫£i danh s√°ch k√™nh...</div>
  <div id="player-area">
    <video id="video" controls autoplay></video>
    <div id="now-playing">Ch∆∞a ph√°t k√™nh n√†o</div>
  </div>
</div>

<script>
var CHANNEL_LIST_URL = 'https://raw.githubusercontent.com/HAO1801/HAO/refs/heads/main/4';
var player = null;
const toggleBtn = document.getElementById('toggleListBtn');
const channelList = document.getElementById('channel-list');

toggleBtn.addEventListener('click', function(){
  if(channelList.style.display === 'none'){
    channelList.style.display = 'block';
    toggleBtn.textContent = '‚ò∞';
  }else{
    channelList.style.display = 'none';
    toggleBtn.textContent = 'üì∫';
  }
});

function initPlayer(){
  if(!shaka.Player.isBrowserSupported()){
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Shaka');
    return;
  }

  var video = document.getElementById('video');
  player = new shaka.Player(video);
  player.addEventListener('error', onErrorEvent);

  loadChannelList();
}

function loadChannelList(){
  var listContainer = document.getElementById('channel-list');
  listContainer.textContent = 'ƒêang t·∫£i danh s√°ch k√™nh...';

  // Cache fallback
  var cached = localStorage.getItem('channel_cache');
  if(cached){
    try{
      renderChannels(JSON.parse(cached));
    }catch(e){}
  }

  fetch(CHANNEL_LIST_URL)
    .then(function(res){ return res.text(); })
    .then(function(text){
      var channels = parseKODIM3U(text);
      renderChannels(channels);
      localStorage.setItem('channel_cache', JSON.stringify(channels));
    })
    .catch(function(err){
      console.error(err);
      if(!cached){
        listContainer.innerHTML =
          '<div style="padding:12px;color:#ff8080">' +
          '‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch k√™nh<br>' +
          'üëâ GitHub RAW b·ªã ch·∫∑n tr√™n file://<br>' +
          'üëâ M·ªü file qua server ho·∫∑c app Web Server' +
          '</div>';
      }
    });
}

function renderChannels(channels){
  var listContainer = document.getElementById('channel-list');
  listContainer.innerHTML = '';

  for(var i=0;i<channels.length;i++){
    (function(ch){
      var div = document.createElement('div');
      div.className = 'channel-item';
      div.textContent = ch.name;
      div.onclick = function(){ selectChannel(ch, div); };
      listContainer.appendChild(div);
    })(channels[i]);
  }
}

function parseKODIM3U(text){
  var lines = text.split('\n');
  var channels = [];
  var current = { name:'', url:'', kid:null, key:null, licenseType:null };

  for(var i=0;i<lines.length;i++){
    var line = lines[i].trim();
    if(!line) continue;

    if(line.indexOf('#EXTINF') === 0){
      var idx = line.lastIndexOf(',');
      current = {
        name: idx>-1 ? line.substring(idx+1).trim() : 'K√™nh kh√¥ng t√™n',
        url:'',
        kid:null,
        key:null,
        licenseType:null
      };
    }
    else if(line.indexOf('#KODIPROP') === 0){
      var kv = line.split('=');
      if(kv.length<2) continue;
      var keyName = kv[0].replace('#KODIPROP:','').trim();
      var value = kv.slice(1).join('=').trim();

      if(keyName === 'inputstream.adaptive.license_type'){
        current.licenseType = value.toLowerCase();
      }
      if(keyName === 'inputstream.adaptive.license_key'){
        var parts = value.split(':');
        if(parts.length===2){
          current.kid = parts[0];
          current.key = parts[1];
        }
      }
    }
    else if(line.charAt(0) !== '#'){
      current.url = line;
      channels.push({
        name: current.name,
        url: current.url,
        kid: current.kid,
        key: current.key,
        licenseType: current.licenseType
      });
      current = { name:'', url:'', kid:null, key:null, licenseType:null };
    }
  }
  return channels;
}

function selectChannel(channel, element){
  var items = document.querySelectorAll('.channel-item');
  for(var i=0;i<items.length;i++){
    items[i].classList.remove('active');
  }
  element.classList.add('active');
  document.getElementById('now-playing').textContent = 'ƒêang ph√°t: ' + channel.name;

  try{
    player.configure({ drm:{ clearKeys:{} } });

    if(channel.licenseType === 'clearkey' && channel.kid && channel.key){
      var ck = {};
      ck[channel.kid] = channel.key;
      player.configure({ drm:{ clearKeys: ck } });
    }

    player.load(channel.url);
  }catch(e){
    onError(e);
  }
}

function onErrorEvent(event){ onError(event.detail); }
function onError(error){
  console.error('Shaka Error', error);
  alert('L·ªói ph√°t k√™nh: ' + (error.message || error));
}

document.addEventListener('DOMContentLoaded', initPlayer);
</script>
</body>
</html>
