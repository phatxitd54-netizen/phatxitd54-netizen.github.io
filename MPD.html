<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Shaka Player - Danh s√°ch k√™nh (KODIPROP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Shaka CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">

  <!-- VideoJS CSS (theo y√™u c·∫ßu) -->
  <link href="https://unpkg.com/video.js/dist/video-js.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script

  <style>
    body{
      margin:0;
      font-family:Arial;
      background:#111;
      color:#fff;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    header{
      padding:10px;
      background:#1e1e1e;
      text-align:center;
      font-weight:bold;
    }

    #container{
      display:flex;
      flex:1;
      overflow:hidden;
    }

    #channel-list{
      width:220px;
      background:#1a1a1a;
      overflow-y:auto;
    }

    .channel-item{
      padding:10px;
      border-bottom:1px solid #333;
      cursor:pointer;
    }

    .channel-item:hover{background:#2a2a2a}
    .channel-item.active{background:#0066cc}

    #player-area{
      flex:1;
      background:#000;
      display:flex;
      flex-direction:column;
    }

    video{
      flex:1;
      width:100%;
      height:100%;
      object-fit:contain;
    }

    #now-playing{
      padding:8px;
      background:#1e1e1e;
      border-top:1px solid #333;
      font-size:14px;
    }

    @media (max-width: 768px){
      #channel-list{display:none;}
    }

    #toggleListBtn{
      float:right;
      background:#0066cc;
      color:#fff;
      border:none;
      border-radius:4px;
      padding:6px 10px;
      font-size:16px;
      cursor:pointer;
    }

    #toggleListBtn:hover{
      background:#0080ff;
    }
  </style>
</head>

<body>
<header>
  Shaka Player - Danh s√°ch k√™nh (KODIPROP)
  <button id="toggleListBtn">‚ò∞</button>
</header>

<div id="container">
  <div id="channel-list">ƒêang t·∫£i danh s√°ch k√™nh...</div>
  <div id="player-area">
    <video id="video" controls autoplay></video>
    <div id="now-playing">Ch∆∞a ph√°t k√™nh n√†o</div>
  </div>
</div>

<script>
var CHANNEL_LIST_URL = 'https://raw.githubusercontent.com/HAO1801/HAO/refs/heads/main/4';
var player = null;

const toggleBtn = document.getElementById('toggleListBtn');
const channelList = document.getElementById('channel-list');

toggleBtn.addEventListener('click', function(){
  if(channelList.style.display === 'none'){
    channelList.style.display = 'block';
    toggleBtn.textContent = '‚ò∞';
  }else{
    channelList.style.display = 'none';
    toggleBtn.textContent = 'üì∫';
  }
});

function initPlayer(){
  if(!shaka.Player.isBrowserSupported()){
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Shaka');
    return;
  }

  var video = document.getElementById('video');
  player = new shaka.Player(video);
  player.addEventListener('error', onErrorEvent);

  loadChannelList();
}

function loadChannelList(){
  var listContainer = document.getElementById('channel-list');
  listContainer.textContent = 'ƒêang t·∫£i danh s√°ch k√™nh...';

  var cached = localStorage.getItem('channel_cache');
  if(cached){
    try{
      renderChannels(JSON.parse(cached));
    }catch(e){}
  }

  fetch(CHANNEL_LIST_URL)
    .then(res => res.text())
    .then(text => {
      var channels = parseKODIM3U(text);
      renderChannels(channels);
      localStorage.setItem('channel_cache', JSON.stringify(channels));
    })
    .catch(err => {
      console.error(err);
      if(!cached){
        listContainer.innerHTML =
          '<div style="padding:12px;color:#ff8080">' +
          '‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch k√™nh<br>' +
          'üëâ GitHub RAW b·ªã ch·∫∑n tr√™n file://<br>' +
          'üëâ M·ªü file qua server ho·∫∑c app Web Server' +
          '</div>';
      }
    });
}

// Base64 / Base64URL -> hex
function b64ToHex(b64){
  b64 = b64.replace(/-/g, '+').replace(/_/g, '/');
  var raw = atob(b64);
  var result = '';
  for(var i=0;i<raw.length;i++){
    var hex = raw.charCodeAt(i).toString(16);
    result += ('00' + hex).slice(-2);
  }
  return result;
}

function renderChannels(channels){
  var listContainer = document.getElementById('channel-list');
  listContainer.innerHTML = '';

  channels.forEach(ch => {
    var div = document.createElement('div');
    div.className = 'channel-item';
    div.textContent = ch.name;
    div.onclick = () => selectChannel(ch, div);
    listContainer.appendChild(div);
  });
}

function parseKODIM3U(text){
  var lines = text.split('\n');
  var channels = [];
  var current = {
    name:'', url:'',
    licenseType:null,
    clearKeys:null
  };

  for(var i=0;i<lines.length;i++){
    var line = lines[i].trim();
    if(!line) continue;

    if(line.startsWith('#EXTINF')){
      var idx = line.lastIndexOf(',');
      current = {
        name: idx>-1 ? line.substring(idx+1).trim() : 'K√™nh kh√¥ng t√™n',
        url:'',
        licenseType:null,
        clearKeys:null
      };
    }
    else if(line.startsWith('#KODIPROP')){
      var kv = line.split('=');
      if(kv.length < 2) continue;

      var keyName = kv[0].replace('#KODIPROP:','').trim();
      var value = kv.slice(1).join('=').trim();

      if(keyName === 'inputstream.adaptive.license_type'){
        current.licenseType = value.toLowerCase();
      }

      if(keyName === 'inputstream.adaptive.license_key'){
        try{
          var json = JSON.parse(value);
          if(json.keys && json.keys.length){
            current.clearKeys = {};
            json.keys.forEach(k => {
              var kidHex = b64ToHex(k.kid);
              var keyHex = b64ToHex(k.k);
              current.clearKeys[kidHex] = keyHex;
            });
          }
        }catch(e){
          console.warn('Kh√¥ng parse ƒë∆∞·ª£c license_key JSON', e);
        }
      }
    }
    else if(line.charAt(0) !== '#'){
      current.url = line;
      channels.push(current);
      current = { name:'', url:'', licenseType:null, clearKeys:null };
    }
  }

  return channels;
}

function selectChannel(channel, element){
  document.querySelectorAll('.channel-item')
    .forEach(el => el.classList.remove('active'));

  element.classList.add('active');
  document.getElementById('now-playing').textContent =
    'ƒêang ph√°t: ' + channel.name;

  try{
    player.configure({ drm:{ clearKeys:{} } });

    if(channel.licenseType === 'clearkey' && channel.clearKeys){
      player.configure({ drm:{ clearKeys: channel.clearKeys } });
    }

    player.load(channel.url);
  }catch(e){
    onError(e);
  }
}

function onErrorEvent(event){ onError(event.detail); }

function onError(error){
  console.error('Shaka Error', error);
  alert('L·ªói ph√°t k√™nh: ' + (error.message || error));
}

document.addEventListener('DOMContentLoaded', initPlayer);
</script>
</body>
</html>
