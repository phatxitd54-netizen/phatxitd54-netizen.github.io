<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Shaka Player - MPD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    
<!-- Shaka CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.8.4/plyr.css" />

<!-- Shaka -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>

<!-- Plyr -->
<script src="https://cdn.plyr.io/3.8.4/plyr.polyfilled.js"></script>

<style>
:root{
  --plyr-color-main:#1ac266;
}

body{
  margin:0;
  font-family: "Inter", "Noto Color Emoji", system-ui, sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  padding:10px;
  background:#1e1e1e;
  text-align:center;
  font-weight:bold;
}

#container{
  display:flex;
  flex:1;
  overflow:hidden;
}

#channel-list{
  width:220px;
  background:#1a1a1a;
  overflow-y:auto;
}

.channel-item{
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.channel-item:hover{background:#2a2a2a}
.channel-item.active{background:#0066cc}

#player-area{
  flex:1;
  background:#000;
  display:flex;
  flex-direction:column;
}

video{
  width:100%;
  height:100%;
  background:#000;
}

#now-playing{
  padding:8px;
  background:#1e1e1e;
  border-top:1px solid #333;
  font-size:14px;
}

#toggleListBtn{
  float:right;
  background:#0066cc;
  color:#fff;
  border:none;
  border-radius:4px;
  padding:6px 10px;
  font-size:16px;
  cursor:pointer;
}

@media (max-width:768px){
  #channel-list{display:none;}
}
.noto-color-emoji-regular {
  font-family: "Noto Color Emoji", sans-serif;
  font-weight: 400;
  font-style: normal;
}

.inter-<uniquifier> {
  font-family: "Inter", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
    }
    
.google-sans-<uniquifier> {
  font-family: "Google Sans", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
  font-variation-settings:
    "GRAD" 0;
    }
</style>
</head>

<body>
<header>
  Shaka + Plyr ‚Äì Danh s√°ch k√™nh
  <button id="toggleListBtn">‚ò∞</button>
</header>

<div id="container">
  <div id="channel-list">ƒêang t·∫£i danh s√°ch k√™nh...</div>

  <div id="player-area">
    <video id="video" class="player" playsinline controls></video>
    <div id="now-playing">Ch∆∞a ph√°t k√™nh n√†o</div>
  </div>
</div>

<script>
const CHANNEL_LIST_URL =
'https://raw.githubusercontent.com/HAO1801/HAO/refs/heads/main/4';

let shakaPlayer;
let plyr;

const toggleBtn = document.getElementById('toggleListBtn');
const channelList = document.getElementById('channel-list');

toggleBtn.onclick = () => {
  channelList.style.display =
    channelList.style.display === 'none' ? 'block' : 'none';
};

function isHex(s){
  return /^[0-9a-fA-F]+$/.test(s);
}

function b64ToHex(b64){
  b64 = b64.replace(/-/g,'+').replace(/_/g,'/');
  while (b64.length % 4) b64 += '=';
  const raw = atob(b64);
  let hex='';
  for(let i=0;i<raw.length;i++){
    hex += ('0'+raw.charCodeAt(i).toString(16)).slice(-2);
  }
  return hex;
}
function parseClearKeyJSON(jsonText, cur){
  try {
    const data = JSON.parse(jsonText);
    if (Array.isArray(data.keys)) {
      data.keys.forEach(k=>{
        const kidHex = isHex(k.kid) ? k.kid : b64ToHex(k.kid);
        const keyHex = isHex(k.k)   ? k.k   : b64ToHex(k.k);
        cur.clearKeys[kidHex] = keyHex;

        console.log('üîê ClearKey JSON:', kidHex, keyHex);
      });
    }
  } catch(e){
    console.warn('‚ùå L·ªói parse JSON ClearKey', e);
  }
}

function initPlayer(){
  if(!shaka.Player.isBrowserSupported()){
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Shaka');
    return;
  }

  const video = document.getElementById('video');

  // Plyr
  plyr = new Plyr(video,{
    controls:[
      'play','progress','current-time','mute','volume',
      'settings','fullscreen'
    ]
  });

  // Shaka
  shakaPlayer = new shaka.Player(video);
  shakaPlayer.addEventListener('error', e => alert(e.detail.message));

  loadChannelList();
}

function loadChannelList(){
  fetch(CHANNEL_LIST_URL)
    .then(r=>r.text())
    .then(t=>renderChannels(parseKODIM3U(t)))
    .catch(()=>channelList.innerHTML='‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch k√™nh');
}

function renderChannels(channels){
  channelList.innerHTML='';
  channels.forEach(ch=>{
    const d=document.createElement('div');
    d.className='channel-item';
    d.textContent=ch.name;
    d.onclick=()=>selectChannel(ch,d);
    channelList.appendChild(d);
  });
}

function parseKODIM3U(text){
  const lines = text.split('\n');
  const channels = [];
  let cur = null;
  let collectingJSON = false;
  let jsonBuffer = '';

  lines.forEach(line=>{
    let l = line.trim();
    if(!l) return;

    // EXTINF
    if(l.startsWith('#EXTINF')){
      cur = {
        name: l.split(',').pop(),
        url: '',
        licenseType: null,
        clearKeys: {}
      };
    }

    // KODIPROP
    else if(l.startsWith('#KODIPROP') && cur){
      const key = l.split('=')[0];
      const val = l.includes('=') ? l.split('=').slice(1).join('=').trim() : '';

      if (key.includes('license_type')){
        cur.licenseType = val.toLowerCase();
      }

      // ===== LICENSE KEY =====
      if (key.includes('license_key')) {

        // JSON b·∫Øt ƒë·∫ßu (c√≥ th·ªÉ xu·ªëng d√≤ng)
        if (val.startsWith('{')) {
          collectingJSON = true;
          jsonBuffer = val;

          // JSON g·ªçn 1 d√≤ng
          if (val.endsWith('}')) {
            collectingJSON = false;
            parseClearKeyJSON(jsonBuffer, cur);
            jsonBuffer = '';
          }
        }

        // kid:key (HEX / Base64 / Base64URL)
        else if (val.includes(':')) {
          const [kidRaw, keyRaw] = val.split(':');
          const kidHex = isHex(kidRaw) ? kidRaw : b64ToHex(kidRaw);
          const keyHex = isHex(keyRaw) ? keyRaw : b64ToHex(keyRaw);
          cur.clearKeys[kidHex] = keyHex;

          console.log('üîë ClearKey:', kidHex, keyHex);
        }
      }
    }

    // Thu th·∫≠p JSON nhi·ªÅu d√≤ng
    else if (collectingJSON && cur){
      jsonBuffer += l;
      if (l.endsWith('}')) {
        collectingJSON = false;
        parseClearKeyJSON(jsonBuffer, cur);
        jsonBuffer = '';
      }
    }

    // URL
    else if (!l.startsWith('#') && cur){
      cur.url = l;
      channels.push(cur);
      cur = null;
    }
  });

  return channels;
}

function selectChannel(ch,el){
  document.querySelectorAll('.channel-item')
    .forEach(e=>e.classList.remove('active'));
  el.classList.add('active');

  document.getElementById('now-playing').textContent='ƒêang ph√°t: '+ch.name;

  shakaPlayer.configure({drm:{clearKeys:{}}});

  if(ch.licenseType==='clearkey' && ch.clearKeys){
    shakaPlayer.configure({drm:{clearKeys:ch.clearKeys}});
  }

  shakaPlayer.load(ch.url).then(()=>plyr.play());
}

document.addEventListener('DOMContentLoaded', initPlayer);
</script>
</body>
</html>
