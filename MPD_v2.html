<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Shaka Player - KODIPROP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&family=Inter:ital,opsz,wght@0,14..32,100..900&family=Noto+Color+Emoji&display=swap" rel="stylesheet">

<!-- Shaka -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>

<!-- Plyr -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<style>
body{
  margin:0;
  font-family:"Inter","Google Sans","Noto Color Emoji",Arial,sans-serif;
  background:#111;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#1e1e1e;
  padding:10px;
  text-align:center;
  font-weight:600;
}
#container{flex:1;display:flex;overflow:hidden}
#channel-list{
  width:240px;
  background:#1a1a1a;
  overflow-y:auto;
}
.channel-item{
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.channel-item:hover{background:#2a2a2a}
.channel-item.active{background:#0066cc}
#player-area{flex:1;display:flex;flex-direction:column;background:#000}
video{flex:1;width:100%;height:100%}
#now-playing{
  padding:8px;
  background:#1e1e1e;
  border-top:1px solid #333;
}
#toggleListBtn{
  float:right;
  background:#0066cc;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  font-size:16px;
  cursor:pointer;
  margin-left:10px;
}
#toggleListBtn:hover{
  background:#0080ff;
}

@media (max-width:768px){
  #channel-list{
    position:absolute;
    z-index:10;
    height:100%;
    left:0;
    top:50px;
  }
}
</style>
</head>

<body><header>
  <span>Shaka Player ‚Äì KODIPROP</span>
  <button id="toggleListBtn">‚ò∞</button>
</header>


<div id="container">
  <div id="channel-list">ƒêang t·∫£i danh s√°ch‚Ä¶</div>
  <div id="player-area">
    <video id="video" playsinline controls></video>
    <div id="now-playing">Ch∆∞a ph√°t k√™nh</div>
  </div>
</div>

<script>
    const toggleBtn = document.getElementById('toggleListBtn');

toggleBtn.onclick = ()=>{
  if(channelList.style.display === 'none'){
    channelList.style.display = 'block';
    toggleBtn.textContent = '‚ò∞';
  }else{
    channelList.style.display = 'none';
    toggleBtn.textContent = 'üì∫';
  }
};
const CHANNEL_LIST_URL = 'https://raw.githubusercontent.com/HAO1801/HAO/refs/heads/main/4';

const video = document.getElementById('video');
const channelList = document.getElementById('channel-list');
const shakaPlayer = new shaka.Player(video);
const plyr = new Plyr(video);

/* ================= HELPERS ================= */

function safeText(str){
  return String(str||'').replace(/[<>&"]/g,s=>({
    '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'
  })[s]);
}

function isHex(s){ return /^[0-9a-fA-F]{32}$/.test(s); }

function hexToBase64Url(hex){
  const b=new Uint8Array(hex.match(/.{2}/g).map(x=>parseInt(x,16)));
  let s=''; b.forEach(x=>s+=String.fromCharCode(x));
  return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function b64ToHex(b){
  b=b.replace(/-/g,'+').replace(/_/g,'/');
  while(b.length%4) b+='=';
  const bin=atob(b);
  return [...bin].map(c=>('0'+c.charCodeAt(0).toString(16)).slice(-2)).join('');
}

function resetDRM(){
  shakaPlayer.configure({drm:{clearKeys:{}}});
}

function parseClearKeyJSON(jsonText, cur){
  try{
    const obj = JSON.parse(jsonText);
    if(obj.keys){
      obj.keys.forEach(k=>{
        const kidHex=isHex(k.kid)?k.kid:b64ToHex(k.kid);
        const keyHex=isHex(k.k)?k.k:b64ToHex(k.k);
        cur.clearKeys[hexToBase64Url(kidHex)] = hexToBase64Url(keyHex);
      });
    }
  }catch(e){ console.error(e); }
}

/* ================= LOAD LIST ================= */

function loadChannelList(){
  fetch(CHANNEL_LIST_URL)
    .then(r=>r.text())
    .then(t=>renderChannels(parseKODIM3U(t)))
    .catch(()=>channelList.innerHTML='‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch');
}

function renderChannels(channels){
  channelList.innerHTML='';
  channels.forEach(ch=>{
    const d=document.createElement('div');
    d.className='channel-item';
    d.textContent=safeText(ch.name);
    d.onclick=()=>selectChannel(ch,d);
    channelList.appendChild(d);
  });
}

/* ================= PARSER ================= */

function parseKODIM3U(text){
  const lines=text.split('\n');
  const channels=[];
  let cur=null, collecting=false, jsonBuf='';

  lines.forEach(l=>{
    l=l.trim(); if(!l) return;

    if(l.startsWith('#EXTINF')){
      cur={name:l.split(',').pop(),url:'',licenseType:null,clearKeys:{}};
    }
    else if(l.startsWith('#KODIPROP') && cur){
      const key=l.split('=')[0];
      const val=l.includes('=')?l.split('=').slice(1).join('=').trim():'';

      if(key.includes('license_type')) cur.licenseType=val.toLowerCase();

      if(key.includes('license_key')){
        if(val.startsWith('{')){
          collecting=true; jsonBuf=val;
          if(val.endsWith('}')){
            collecting=false; parseClearKeyJSON(jsonBuf,cur); jsonBuf='';
          }
        }
        else if(val.includes(':')){
          const [k1,k2]=val.split(':');
          const kidHex=isHex(k1)?k1:b64ToHex(k1);
          const keyHex=isHex(k2)?k2:b64ToHex(k2);
          cur.clearKeys[hexToBase64Url(kidHex)] = hexToBase64Url(keyHex);
        }
      }
    }
    else if(collecting && cur){
      jsonBuf+=l;
      if(l.endsWith('}')){
        collecting=false; parseClearKeyJSON(jsonBuf,cur); jsonBuf='';
      }
    }
    else if(!l.startsWith('#') && cur){
      cur.url=l; channels.push(cur); cur=null;
    }
  });
  return channels;
}

/* ================= PLAY ================= */

function selectChannel(ch,el){
  document.querySelectorAll('.channel-item').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');

  document.getElementById('now-playing').textContent='ƒêang ph√°t: '+safeText(ch.name);

  resetDRM();
  if(ch.licenseType==='clearkey') shakaPlayer.configure({drm:{clearKeys:ch.clearKeys}});
  shakaPlayer.load(ch.url).then(()=>plyr.play());
}

loadChannelList();
</script>
</body>
</html>
